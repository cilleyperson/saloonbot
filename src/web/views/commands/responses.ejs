<%- include('../layout', { body: `
<div class="page">
  ${(function() {
    const escapeHtml = (str) => {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };
    const displayName = escapeHtml(channel.display_name || channel.twitch_username);
    const cmdName = escapeHtml(command.command_name);

    return `
  <div class="page-header">
    <div class="page-header-content">
      <a href="/channels/${channel.id}/commands/${command.id}/edit" class="back-link">&larr; Back to Command</a>
      <h1 class="page-title">Responses for !${cmdName}</h1>
      <p class="page-subtitle">${displayName}</p>
    </div>
  </div>

  <div class="page-content">
    <div class="card mb-6">
      <div class="card-header">
        <h3 class="card-title">Add New Response</h3>
      </div>
      <div class="card-body">
        <form action="/channels/${channel.id}/commands/${command.id}/responses" method="POST">
          <input type="hidden" name="_csrf" value="${csrfToken}">
          <div class="form-group">
            <label for="response_text" class="form-label">Response Text</label>
            <textarea name="response_text" id="response_text" rows="3" class="form-input" required></textarea>
            <p class="form-hint">
              Variables: <code>{user}</code> <code>{channel}</code> <code>{args}</code> <code>{arg1}</code> <code>{arg2}</code> <code>{arg3}</code>
            </p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label for="weight" class="form-label">Weight</label>
              <input type="number" name="weight" id="weight" value="1" min="1" max="100" class="form-input">
              <p class="form-hint">Higher weight = more likely to be selected (1-100)</p>
            </div>
            <div class="form-group" style="display: flex; align-items: flex-end;">
              <button type="submit" class="btn btn-primary">Add Response</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="card mb-6">
      <div class="card-header">
        <h3 class="card-title">Import Responses from File</h3>
      </div>
      <div class="card-body">
        <form action="/channels/${channel.id}/commands/${command.id}/responses/import?_csrf=${encodeURIComponent(csrfToken)}" method="POST" enctype="multipart/form-data">
          <div class="form-group">
            <label for="responses_file" class="form-label">Select Text File</label>
            <input type="file" name="responses_file" id="responses_file" accept=".txt" class="form-input" required>
            <p class="form-hint">
              Upload a .txt file with one response per line. Each response will be added with weight 1.
              Maximum file size: 1MB.
            </p>
          </div>
          <button type="submit" class="btn btn-secondary">Import Responses</button>
        </form>
      </div>
    </div>

    ${responses.length > 0 ? `
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Existing Responses (${pagination.total} total)</h3>
      </div>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th style="width: 50%;">Response</th>
              <th>Weight</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${responses.map((resp, index) => {
              const respText = escapeHtml(resp.response_text);
              return `
            <tr class="${resp.is_enabled ? '' : 'row-muted'}" id="response-${resp.id}">
              <td>
                <form action="/channels/${channel.id}/commands/${command.id}/responses/${resp.id}" method="POST" class="inline-edit-form">
                  <input type="hidden" name="_csrf" value="${csrfToken}">
                  <textarea name="response_text" rows="2" class="form-input" required>${respText}</textarea>
              </td>
              <td>
                  <input type="number" name="weight" value="${resp.weight}" min="1" max="100" class="form-input" style="width: 80px;">
              </td>
              <td>
                  <label class="form-checkbox">
                    <input type="checkbox" name="is_enabled" ${resp.is_enabled ? 'checked' : ''}>
                    <span class="form-checkbox-label">Enabled</span>
                  </label>
              </td>
              <td>
                <div class="btn-group">
                  <button type="submit" class="btn btn-sm btn-primary">Save</button>
                </form>
                <form action="/channels/${channel.id}/commands/${command.id}/responses/${resp.id}/delete" method="POST" class="inline-form">
                  <input type="hidden" name="_csrf" value="${csrfToken}">
                  <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this response?')">Delete</button>
                </form>
                </div>
              </td>
            </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>

      ${pagination.pages > 1 ? `
      <div class="card-footer">
        <div class="pagination">
          ${pagination.page > 1 ? `
            <a href="/channels/${channel.id}/commands/${command.id}/responses?page=${pagination.page - 1}" class="btn btn-sm btn-secondary">&laquo; Previous</a>
          ` : ''}
          <span class="pagination-info text-secondary">Page ${pagination.page} of ${pagination.pages}</span>
          ${pagination.page < pagination.pages ? `
            <a href="/channels/${channel.id}/commands/${command.id}/responses?page=${pagination.page + 1}" class="btn btn-sm btn-secondary">Next &raquo;</a>
          ` : ''}
        </div>
      </div>
      ` : ''}
    </div>
    ` : `
    <div class="card">
      <div class="card-body">
        <div class="empty-state">
          <p>No responses configured yet. Add one above to get started!</p>
        </div>
      </div>
    </div>
    `}
  </div>
    `;
  })()}
</div>
`, activePage: 'commands', channel: channel }) %>
