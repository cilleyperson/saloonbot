<%- include('../layout', { body: `
<div class="page">
  ${(function() {
    const escapeHtml = (str) => {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };
    const displayName = escapeHtml(channel.display_name || channel.twitch_username);
    const username = escapeHtml(channel.twitch_username);
    const cmdName = command ? escapeHtml(command.command_name) : '';
    const cmdResponse = command ? escapeHtml(command.response) : '';
    const cmdEmoji = command && command.emoji ? escapeHtml(command.emoji) : '';

    return `
  <div class="page-header">
    <div class="page-header-content">
      <a href="/channels/${channel.id}/commands" class="back-link">&larr; Back to Commands</a>
      <h1 class="page-title">${isNew ? 'New Command' : 'Edit Command'}</h1>
      <p class="page-subtitle">${displayName}</p>
    </div>
  </div>

  <div class="page-content">
    <form action="/channels/${channel.id}/commands${isNew ? '' : '/' + command.id}" method="POST">
      <input type="hidden" name="_csrf" value="${csrfToken}">

      <div class="card mb-6">
        <div class="card-header">
          <h3 class="card-title">Command Details</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="command_name" class="form-label">Command Name</label>
            <div class="input-group">
              <span class="input-group-text">!</span>
              <input type="text" name="command_name" id="command_name"
                     value="${cmdName}"
                     class="form-input"
                     placeholder="hello"
                     pattern="[a-zA-Z0-9_]+"
                     ${isNew ? '' : 'readonly'}
                     required>
            </div>
            <p class="form-hint">Letters, numbers, and underscores only. ${isNew ? '' : 'Cannot be changed after creation.'}</p>
          </div>

          <div class="form-group">
            <label class="form-label">Response Mode</label>
            <div class="form-radio-group">
              <label class="form-radio">
                <input type="radio" name="response_mode" value="single" ${(!command || command.response_mode === 'single') ? 'checked' : ''} onchange="toggleResponseMode(this)">
                <span class="form-radio-label">Single Response</span>
              </label>
              <label class="form-radio">
                <input type="radio" name="response_mode" value="random" ${command && command.response_mode === 'random' ? 'checked' : ''} onchange="toggleResponseMode(this)">
                <span class="form-radio-label">Random from List</span>
              </label>
            </div>
            <p class="form-hint">Choose whether the command uses a single response or picks randomly from a list</p>
          </div>

          <div class="form-group" id="single-response-section" style="display: ${command && command.response_mode === 'random' ? 'none' : 'block'};">
            <label for="response" class="form-label">Response</label>
            <textarea name="response" id="response" rows="4" class="form-input">${cmdResponse}</textarea>
            <p class="form-hint">
              Variables: <code>{user}</code> <code>{channel}</code> <code>{args}</code> <code>{arg1}</code> <code>{arg2}</code> <code>{arg3}</code>
            </p>
          </div>

          ${!isNew && command && command.response_mode === 'random' ? `
          <div class="form-group" id="random-response-section">
            <label class="form-label">Random Responses</label>
            <div class="alert alert-info">
              <p>This command uses random responses. <strong>${responseCount || 0}</strong> response(s) configured.</p>
              <a href="/channels/${channel.id}/commands/${command.id}/responses" class="btn btn-sm btn-secondary mt-2">Manage Responses</a>
            </div>
            <p class="form-hint">
              Variables available in responses: <code>{user}</code> <code>{channel}</code> <code>{args}</code> <code>{arg1}</code> <code>{arg2}</code> <code>{arg3}</code>
            </p>
          </div>
          ` : ''}

          ${isNew ? `
          <div class="form-group" id="random-response-hint" style="display: ${command && command.response_mode === 'random' ? 'block' : 'none'};">
            <div class="alert alert-warning">
              <p>After creating the command, you can add multiple responses from the command's edit page.</p>
            </div>
          </div>
          ` : ''}
        </div>
      </div>

      <div class="card mb-6">
        <div class="card-header">
          <h3 class="card-title">Settings</h3>
        </div>
        <div class="card-body">
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label for="cooldown_seconds" class="form-label">Cooldown (seconds)</label>
              <input type="number" name="cooldown_seconds" id="cooldown_seconds"
                     value="${command ? command.cooldown_seconds : 5}"
                     class="form-input"
                     min="0" max="3600">
              <p class="form-hint">Time between uses (0-3600)</p>
            </div>

            <div class="form-group">
              <label for="user_level" class="form-label">User Level</label>
              <select name="user_level" id="user_level" class="form-select">
                ${userLevels.map(level => {
                  const levelEscaped = escapeHtml(level);
                  return `<option value="${levelEscaped}" ${command && command.user_level === level ? 'selected' : ''}>${levelEscaped}</option>`;
                }).join('')}
              </select>
              <p class="form-hint">Minimum permission level required</p>
            </div>
          </div>

          ${!isNew ? `
          <div class="form-group">
            <label class="form-checkbox">
              <input type="checkbox" name="is_enabled" ${command.is_enabled ? 'checked' : ''}>
              <span class="form-checkbox-label">Command Enabled</span>
            </label>
          </div>
          ` : ''}
        </div>
      </div>

      <div class="card mb-6">
        <div class="card-header">
          <h3 class="card-title">Response Emoji (Optional)</h3>
        </div>
        <div class="card-body">
          <div class="emoji-picker-container">
            <div class="form-group">
              <div class="input-group">
                <input type="text" name="emoji" id="emoji"
                       value="${cmdEmoji}"
                       class="form-input"
                       placeholder="Click an emoji below"
                       readonly>
                <button type="button" class="btn btn-secondary" onclick="clearEmoji()">Clear</button>
              </div>
            </div>
            <div class="emoji-grid" id="emoji-grid"></div>
            <div class="form-group mt-4">
              <label class="form-label">Emoji Position</label>
              <div class="form-radio-group">
                <label class="form-radio">
                  <input type="radio" name="emoji_position" value="start" ${(!command || !command.emoji_position || command.emoji_position === 'start') ? 'checked' : ''}>
                  <span class="form-radio-label">Start of message</span>
                </label>
                <label class="form-radio">
                  <input type="radio" name="emoji_position" value="end" ${command && command.emoji_position === 'end' ? 'checked' : ''}>
                  <span class="form-radio-label">End of message</span>
                </label>
              </div>
            </div>
          </div>
          <p class="form-hint">Select an emoji to prefix or suffix all responses from this command</p>
        </div>
      </div>

      <div class="card mb-6">
        <div class="card-header">
          <h3 class="card-title">Chat Scope</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <div class="form-radio-group">
              <label class="form-radio">
                <input type="radio" name="chat_scope" value="all" ${(!command || command.chat_scope === 'all') ? 'checked' : ''} onchange="toggleChatSelection(this)">
                <span class="form-radio-label">All Chats (own + memberships)</span>
              </label>
              <label class="form-radio">
                <input type="radio" name="chat_scope" value="selected" ${command && command.chat_scope === 'selected' ? 'checked' : ''} onchange="toggleChatSelection(this)">
                <span class="form-radio-label">Selected Chats Only</span>
              </label>
            </div>
            <p class="form-hint">Choose which chats this command responds in</p>
          </div>

          <div class="form-group" id="chat-selection" style="display: ${command && command.chat_scope === 'selected' ? 'block' : 'none'};">
            <label class="form-label">Select Chats</label>
            <div class="form-checkbox-group">
              <label class="form-checkbox">
                <input type="checkbox" name="chat_scopes[]" value="__own__" ${command && command.selected_chats && command.selected_chats.includes('__own__') ? 'checked' : ''}>
                <span class="form-checkbox-label">Own Chat (${username})</span>
              </label>
              ${chatMemberships && chatMemberships.length > 0 ? chatMemberships.map(m => {
                const targetChannel = escapeHtml(m.target_channel);
                return `
              <label class="form-checkbox">
                <input type="checkbox" name="chat_scopes[]" value="${targetChannel}" ${command && command.selected_chats && command.selected_chats.includes(m.target_channel) ? 'checked' : ''}>
                <span class="form-checkbox-label">${targetChannel}</span>
              </label>
                `;
              }).join('') : '<p class="text-secondary">No chat memberships configured. <a href="/channels/' + channel.id + '/chat-memberships/new">Add one</a>.</p>'}
            </div>
            <p class="form-hint">At least one chat must be selected when using "Selected Chats Only"</p>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">${isNew ? 'Create Command' : 'Save Changes'}</button>
        <a href="/channels/${channel.id}/commands" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </div>

  <script>
    function toggleChatSelection(radio) {
      var chatSelection = document.getElementById('chat-selection');
      chatSelection.style.display = radio.value === 'selected' ? 'block' : 'none';
    }

    function toggleResponseMode(radio) {
      var singleSection = document.getElementById('single-response-section');
      var randomHint = document.getElementById('random-response-hint');
      var responseField = document.getElementById('response');

      if (radio.value === 'random') {
        if (singleSection) singleSection.style.display = 'none';
        if (randomHint) randomHint.style.display = 'block';
        if (responseField) responseField.removeAttribute('required');
      } else {
        if (singleSection) singleSection.style.display = 'block';
        if (randomHint) randomHint.style.display = 'none';
        if (responseField) responseField.setAttribute('required', 'required');
      }
    }

    var popularEmojis = [
      'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ˜Š',
      'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§',
      'ğŸ˜', 'ğŸ¥³', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ¥º',
      'ğŸ®', 'ğŸ•¹ï¸', 'ğŸ¯', 'ğŸ²', 'ğŸƒ', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…',
      'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'ğŸ”¥', 'ğŸ’¥', 'ğŸ’¯', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›',
      'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’–', 'ğŸ’',
      'ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ‘Š',
      'ğŸ’ª', 'ğŸ¦¾', 'ğŸ§ ', 'ğŸ‘€', 'ğŸ±', 'ğŸ¶', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ¯', 'ğŸ¦„',
      'ğŸ•', 'ğŸ”', 'ğŸŸ', 'â˜•', 'ğŸµ', 'ğŸº', 'ğŸ»', 'ğŸ¥¤', 'ğŸ·', 'ğŸ¥‚',
      'ğŸš€', 'âœˆï¸', 'ğŸ', 'ğŸ€', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'âš¡', 'â˜€ï¸', 'ğŸŒ™'
    ];

    function initEmojiPicker() {
      var grid = document.getElementById('emoji-grid');
      if (!grid) return;
      while (grid.firstChild) grid.removeChild(grid.firstChild);
      popularEmojis.forEach(function(emoji) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'emoji-btn';
        btn.textContent = emoji;
        btn.onclick = function() { selectEmoji(emoji); };
        grid.appendChild(btn);
      });
    }

    function selectEmoji(emoji) {
      document.getElementById('emoji').value = emoji;
      var buttons = document.querySelectorAll('.emoji-btn');
      buttons.forEach(function(btn) {
        btn.classList.remove('selected');
        if (btn.textContent === emoji) btn.classList.add('selected');
      });
    }

    function clearEmoji() {
      document.getElementById('emoji').value = '';
      var buttons = document.querySelectorAll('.emoji-btn');
      buttons.forEach(function(btn) { btn.classList.remove('selected'); });
    }

    document.addEventListener('DOMContentLoaded', function() {
      initEmojiPicker();
      var currentEmoji = document.getElementById('emoji').value;
      if (currentEmoji) {
        var buttons = document.querySelectorAll('.emoji-btn');
        buttons.forEach(function(btn) {
          if (btn.textContent === currentEmoji) btn.classList.add('selected');
        });
      }
    });
  </script>
    `;
  })()}
</div>
`, activePage: 'commands', channel: channel }) %>
