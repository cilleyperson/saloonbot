<%- include('../layout', { body: `
<div class="page">
  ${(function() {
    const escapeHtml = (str) => {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };
    const displayName = escapeHtml(channel.display_name || channel.twitch_username);
    const username = escapeHtml(channel.twitch_username);
    const cntName = counter ? escapeHtml(counter.counter_name) : '';
    const cntTemplate = counter ? escapeHtml(counter.response_template) : '{counter} count: {count}';
    const cntEmoji = counter && counter.emoji ? escapeHtml(counter.emoji) : '';

    return `
  <div class="page-header">
    <div class="page-header-content">
      <a href="/channels/${channel.id}/counters" class="back-link">&larr; Back to Counters</a>
      <h1 class="page-title">${isNew ? 'New Counter' : 'Edit Counter'}</h1>
      <p class="page-subtitle">${displayName}</p>
    </div>
  </div>

  <div class="page-content">
    <form action="/channels/${channel.id}/counters${isNew ? '' : '/' + counter.id}" method="POST">
      <input type="hidden" name="_csrf" value="${csrfToken}">

      <div class="card mb-6">
        <div class="card-header">
          <h3 class="card-title">Counter Details</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="counter_name" class="form-label">Counter Name</label>
            <div class="input-group">
              <input type="text" name="counter_name" id="counter_name"
                     value="${cntName}"
                     class="form-input"
                     placeholder="death"
                     pattern="[a-zA-Z0-9_]+"
                     ${isNew ? '' : 'readonly'}
                     required>
              <span class="input-group-text">++</span>
            </div>
            <p class="form-hint">Letters, numbers, and underscores only. ${isNew ? '' : 'Cannot be changed after creation.'}</p>
          </div>

          <div class="form-group">
            <label for="response_template" class="form-label">Response Template</label>
            <input type="text" name="response_template" id="response_template"
                   value="${cntTemplate}"
                   class="form-input">
            <p class="form-hint">
              Variables: <code>{counter}</code> <code>{count}</code> <code>{user}</code>
            </p>
          </div>

          ${isNew ? `
          <div class="form-group">
            <label for="initial_count" class="form-label">Starting Count</label>
            <input type="number" name="initial_count" id="initial_count" value="0" class="form-input" min="0">
            <p class="form-hint">Initial count value (defaults to 0)</p>
          </div>
          ` : `
          <div class="form-group">
            <label class="form-label">Current Count</label>
            <p class="form-static"><strong>${counter.current_count}</strong></p>
            <p class="form-hint">Use the Reset button on the counters list to reset to 0</p>
          </div>

          <div class="form-group">
            <label class="form-checkbox">
              <input type="checkbox" name="is_enabled" ${counter.is_enabled ? 'checked' : ''}>
              <span class="form-checkbox-label">Counter Enabled</span>
            </label>
          </div>
          `}
        </div>
      </div>

      <div class="card mb-6">
        <div class="card-header">
          <h3 class="card-title">Response Emoji (Optional)</h3>
        </div>
        <div class="card-body">
          <div class="emoji-picker-container">
            <div class="form-group">
              <div class="input-group">
                <input type="text" name="emoji" id="emoji"
                       value="${cntEmoji}"
                       class="form-input"
                       placeholder="Click an emoji below"
                       readonly>
                <button type="button" class="btn btn-secondary" onclick="clearEmoji()">Clear</button>
              </div>
            </div>
            <div class="emoji-grid" id="emoji-grid"></div>
            <div class="form-group mt-4">
              <label class="form-label">Emoji Position</label>
              <div class="form-radio-group">
                <label class="form-radio">
                  <input type="radio" name="emoji_position" value="start" ${(!counter || !counter.emoji_position || counter.emoji_position === 'start') ? 'checked' : ''}>
                  <span class="form-radio-label">Start of message</span>
                </label>
                <label class="form-radio">
                  <input type="radio" name="emoji_position" value="end" ${counter && counter.emoji_position === 'end' ? 'checked' : ''}>
                  <span class="form-radio-label">End of message</span>
                </label>
              </div>
            </div>
          </div>
          <p class="form-hint">Select an emoji to prefix or suffix all responses from this counter</p>
        </div>
      </div>

      <div class="card mb-6">
        <div class="card-header">
          <h3 class="card-title">Chat Scope</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <div class="form-radio-group">
              <label class="form-radio">
                <input type="radio" name="chat_scope" value="all" ${(!counter || counter.chat_scope === 'all') ? 'checked' : ''} onchange="toggleChatSelection(this)">
                <span class="form-radio-label">All Chats (own + memberships)</span>
              </label>
              <label class="form-radio">
                <input type="radio" name="chat_scope" value="selected" ${counter && counter.chat_scope === 'selected' ? 'checked' : ''} onchange="toggleChatSelection(this)">
                <span class="form-radio-label">Selected Chats Only</span>
              </label>
            </div>
            <p class="form-hint">Choose which chats this counter responds in</p>
          </div>

          <div class="form-group" id="chat-selection" style="display: ${counter && counter.chat_scope === 'selected' ? 'block' : 'none'};">
            <label class="form-label">Select Chats</label>
            <div class="form-checkbox-group">
              <label class="form-checkbox">
                <input type="checkbox" name="chat_scopes[]" value="__own__" ${counter && counter.selected_chats && counter.selected_chats.includes('__own__') ? 'checked' : ''}>
                <span class="form-checkbox-label">Own Chat (${username})</span>
              </label>
              ${chatMemberships && chatMemberships.length > 0 ? chatMemberships.map(m => {
                const targetChannel = escapeHtml(m.target_channel);
                return `
              <label class="form-checkbox">
                <input type="checkbox" name="chat_scopes[]" value="${targetChannel}" ${counter && counter.selected_chats && counter.selected_chats.includes(m.target_channel) ? 'checked' : ''}>
                <span class="form-checkbox-label">${targetChannel}</span>
              </label>
                `;
              }).join('') : '<p class="text-secondary">No chat memberships configured. <a href="/channels/' + channel.id + '/chat-memberships/new">Add one</a>.</p>'}
            </div>
            <p class="form-hint">At least one chat must be selected when using "Selected Chats Only"</p>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">${isNew ? 'Create Counter' : 'Save Changes'}</button>
        <a href="/channels/${channel.id}/counters" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </div>

  <script>
    function toggleChatSelection(radio) {
      var chatSelection = document.getElementById('chat-selection');
      chatSelection.style.display = radio.value === 'selected' ? 'block' : 'none';
    }

    var popularEmojis = [
      'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ˜Š',
      'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§',
      'ğŸ˜', 'ğŸ¥³', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ¥º',
      'ğŸ®', 'ğŸ•¹ï¸', 'ğŸ¯', 'ğŸ²', 'ğŸƒ', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…',
      'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'ğŸ”¥', 'ğŸ’¥', 'ğŸ’¯', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›',
      'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’–', 'ğŸ’',
      'ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ‘Š',
      'ğŸ’ª', 'ğŸ¦¾', 'ğŸ§ ', 'ğŸ‘€', 'ğŸ±', 'ğŸ¶', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ¯', 'ğŸ¦„',
      'ğŸ•', 'ğŸ”', 'ğŸŸ', 'â˜•', 'ğŸµ', 'ğŸº', 'ğŸ»', 'ğŸ¥¤', 'ğŸ·', 'ğŸ¥‚',
      'ğŸš€', 'âœˆï¸', 'ğŸ', 'ğŸ€', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'âš¡', 'â˜€ï¸', 'ğŸŒ™'
    ];

    function initEmojiPicker() {
      var grid = document.getElementById('emoji-grid');
      if (!grid) return;
      while (grid.firstChild) grid.removeChild(grid.firstChild);
      popularEmojis.forEach(function(emoji) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'emoji-btn';
        btn.textContent = emoji;
        btn.onclick = function() { selectEmoji(emoji); };
        grid.appendChild(btn);
      });
    }

    function selectEmoji(emoji) {
      document.getElementById('emoji').value = emoji;
      var buttons = document.querySelectorAll('.emoji-btn');
      buttons.forEach(function(btn) {
        btn.classList.remove('selected');
        if (btn.textContent === emoji) btn.classList.add('selected');
      });
    }

    function clearEmoji() {
      document.getElementById('emoji').value = '';
      var buttons = document.querySelectorAll('.emoji-btn');
      buttons.forEach(function(btn) { btn.classList.remove('selected'); });
    }

    document.addEventListener('DOMContentLoaded', function() {
      initEmojiPicker();
      var currentEmoji = document.getElementById('emoji').value;
      if (currentEmoji) {
        var buttons = document.querySelectorAll('.emoji-btn');
        buttons.forEach(function(btn) {
          if (btn.textContent === currentEmoji) btn.classList.add('selected');
        });
      }
    });
  </script>
    `;
  })()}
</div>
`, activePage: 'counters', channel: channel }) %>
