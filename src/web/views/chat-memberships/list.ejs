<%- include('../layout', { body: `
<div class="page">
  ${(function() {
    const escapeHtml = (str) => {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };
    const displayName = escapeHtml(channel.display_name || channel.twitch_username);
    const username = escapeHtml(channel.twitch_username);
    const joinedChatsEscaped = joinedChats.map(c => escapeHtml(c)).join(', ');

    return `
  <div class="page-header">
    <div class="page-header-content">
      <a href="/channels/${channel.id}" class="back-link">&larr; Back to Channel</a>
      <h1 class="page-title">Chat Memberships</h1>
      <p class="page-subtitle">${displayName}</p>
    </div>
    <div class="page-header-actions">
      <a href="/channels/${channel.id}/chat-memberships/new" class="btn btn-primary">Join Chat</a>
    </div>
  </div>

  <div class="page-content">
    <div class="card mb-6">
      <div class="card-header">
        <h3 class="card-title">What are Chat Memberships?</h3>
      </div>
      <div class="card-body">
        <p class="text-secondary mb-2">Chat memberships allow the bot to join and participate in other Twitch channels' chats on your behalf. The bot automatically joins your own channel, but you can add additional channels here.</p>
        <p class="text-secondary"><strong>Currently in ${joinedChats.length} chat${joinedChats.length !== 1 ? 's' : ''}:</strong> ${joinedChatsEscaped || 'none'}</p>
      </div>
    </div>

    ${memberships.length > 0 ? `
    <div class="card">
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Channel</th>
              <th>Status</th>
              <th>Added</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${memberships.map(mem => {
              const targetChannel = escapeHtml(mem.target_channel);
              return `
            <tr class="${mem.is_active ? '' : 'row-muted'}">
              <td>
                <a href="https://twitch.tv/${targetChannel}" target="_blank" rel="noopener noreferrer" class="text-primary">
                  ${targetChannel}
                </a>
              </td>
              <td>
                <span class="badge ${mem.is_active ? 'badge-success' : 'badge-error'}">
                  ${mem.is_active ? 'active' : 'inactive'}
                </span>
              </td>
              <td>${new Date(mem.created_at).toLocaleDateString()}</td>
              <td>
                <div class="btn-group">
                  <form action="/channels/${channel.id}/chat-memberships/${mem.id}/toggle" method="POST" class="inline-form">
                    <input type="hidden" name="_csrf" value="${csrfToken}">
                    <button type="submit" class="btn btn-sm btn-secondary">${mem.is_active ? 'Disable' : 'Enable'}</button>
                  </form>
                  <form action="/channels/${channel.id}/chat-memberships/${mem.id}/delete" method="POST" class="inline-form">
                    <input type="hidden" name="_csrf" value="${csrfToken}">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Remove this chat membership?')">Remove</button>
                  </form>
                </div>
              </td>
            </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
    ` : `
    <div class="card">
      <div class="card-body">
        <div class="empty-state">
          <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <h3>No additional chat memberships</h3>
          <p>The bot automatically joins your own channel (${username}).</p>
          <a href="/channels/${channel.id}/chat-memberships/new" class="btn btn-primary mt-4">Join Another Chat</a>
        </div>
      </div>
    </div>
    `}
  </div>
    `;
  })()}
</div>
`, activePage: 'memberships', channel: channel }) %>
